; Changes:
; * removed: 2
; * added: 5
; * swaps: 2
; * negated predicates: 1
; * swapped branches: 0
; * calls to id fun: 3
(letrec ((create-counter (lambda (initial)
                           (letrec ((increase (lambda ()
                                                (set! initial (+ initial 1))))
                                    (decrease (lambda ()
                                                (set! initial (- initial 1))))
                                    (read (lambda ()
                                            initial))
                                    (dispatch (lambda (m)
                                                (<change>
                                                   ()
                                                   "wrong message")
                                                (<change>
                                                   (if (eq? m 'increase)
                                                      (increase)
                                                      (if (eq? m 'decrease)
                                                         (decrease)
                                                         (if (eq? m 'read)
                                                            (read)
                                                            (display "wrong message"))))
                                                   ((lambda (x) x)
                                                      (if (eq? m 'increase)
                                                         (increase)
                                                         (if (eq? m 'decrease)
                                                            (decrease)
                                                            (if (eq? m 'read)
                                                               (read)
                                                               (display "wrong message")))))))))
                              dispatch)))
         (create-parking (lambda capaciteiten
                           (let ((verdieping-ctrs (map create-counter capaciteiten))
                                 (nr-verdiepingen (length capaciteiten))
                                 (nbr-cars 0))
                              (letrec ((total-capacity (lambda ()
                                                         (apply + capaciteiten)))
                                       (full? (lambda ()
                                                (= nbr-cars (total-capacity))))
                                       (empty? (lambda ()
                                                 (= nbr-cars 0)))
                                       (max-reached-level (lambda (level idx)
                                                            (<change>
                                                               ()
                                                               (list-ref capaciteiten (- idx 1)))
                                                            (>= (level 'read) (list-ref capaciteiten (- idx 1)))))
                                       (level-current (lambda ()
                                                        (letrec ((loop (lambda (lst index)
                                                                         (if (null? lst)
                                                                            #f
                                                                            (let* ((level (car lst))
                                                                                   (capacity (level 'read)))
                                                                               (if (> capacity 0)
                                                                                  index
                                                                                  (loop (cdr lst) (+ index 1))))))))
                                                           (loop verdieping-ctrs 1))))
                                       (level-to-leave (lambda ()
                                                         (letrec ((loop (lambda (lst index)
                                                                          (if (null? lst)
                                                                             #f
                                                                             (let* ((level (car lst))
                                                                                    (capacity (level 'read)))
                                                                                (<change>
                                                                                   ()
                                                                                   (display level))
                                                                                (if (if (not (max-reached-level level index)) (>= capacity 0) #f)
                                                                                   index
                                                                                   (loop (cdr lst) (- index 1))))))))
                                                            (<change>
                                                               (loop (reverse verdieping-ctrs) nr-verdiepingen)
                                                               ((lambda (x) x) (loop (reverse verdieping-ctrs) nr-verdiepingen))))))
                                       (car-enters (lambda ()
                                                     (let ((level (level-current)))
                                                        (if level
                                                           (let ((verdieping-ctr (list-ref verdieping-ctrs (- level 1))))
                                                              (set! nbr-cars (+ nbr-cars 1))
                                                              (verdieping-ctr 'decrease))
                                                           #f))))
                                       (car-leaves (lambda ()
                                                     (let ((level (level-to-leave)))
                                                        (if level
                                                           (let ((verdieping-ctr (list-ref verdieping-ctrs (- level 1))))
                                                              (set! nbr-cars (- nbr-cars 1))
                                                              (verdieping-ctr 'increase))
                                                           (let ((verdieping-ctr (list-ref verdieping-ctrs (- nr-verdiepingen 1))))
                                                              (<change>
                                                                 (set! nbr-cars (- nbr-cars 1))
                                                                 (verdieping-ctr 'increase))
                                                              (<change>
                                                                 (verdieping-ctr 'increase)
                                                                 (set! nbr-cars (- nbr-cars 1))))))))
                                       (dispatch (lambda (msg)
                                                   (<change>
                                                      (if (eq? msg 'full?)
                                                         (full?)
                                                         (if (eq? msg 'empty?)
                                                            (empty?)
                                                            (if (eq? msg 'level)
                                                               (level-current)
                                                               (if (eq? msg 'car-enters)
                                                                  (car-enters)
                                                                  (if (eq? msg 'lst)
                                                                     verdieping-ctrs
                                                                     (if (eq? msg 'car-leaves)
                                                                        (car-leaves)
                                                                        (error "wrong message")))))))
                                                      ((lambda (x) x)
                                                         (if (eq? msg 'full?)
                                                            (full?)
                                                            (if (eq? msg 'empty?)
                                                               (empty?)
                                                               (if (eq? msg 'level)
                                                                  (level-current)
                                                                  (if (eq? msg 'car-enters)
                                                                     (car-enters)
                                                                     (if (<change> (eq? msg 'lst) (not (eq? msg 'lst)))
                                                                        verdieping-ctrs
                                                                        (if (eq? msg 'car-leaves)
                                                                           (car-leaves)
                                                                           (error "wrong message"))))))))))))
                                 dispatch))))
         (parking (create-parking 3 5 2)))
   (if (= (parking 'level) 1)
      (if (not (parking 'full?))
         (if (= (begin (<change> (parking 'car-enters) (parking 'car-enters)) (<change> (parking 'car-enters) (parking 'car-enters)) (<change> (parking 'car-enters) ()) (parking 'car-enters) (parking 'level)) 2)
            (if (not (parking 'empty?))
               (if (begin (<change> () (display 'car-enters)) (parking 'car-enters) (parking 'car-enters) (parking 'car-enters) (parking 'car-enters) (<change> (parking 'car-enters) ()) (parking 'car-enters) (parking 'full?))
                  (if (not (parking 'car-enters))
                     (=
                        (begin
                           (parking 'car-leaves)
                           (<change>
                              ()
                              (display 'level))
                           (parking 'car-leaves)
                           (parking 'car-leaves)
                           (parking 'level))
                        2)
                     #f)
                  #f)
               #f)
            #f)
         #f)
      #f))